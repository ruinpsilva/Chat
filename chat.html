
<html>
    <head>
        <title>A.M.A.L.I.A. CHAT</title>

        <link rel="stylesheet" href="chatStyleDark.css" title="Dark"/>
        <link rel="Alternate stylesheet" href="chatStyleLight.css" title="Light"/>


    </head>
    <body>
        <div id="nickWrap">
            <h1>Welcome to the Amalia Chat</h1>
            <p>Please wait...</p>
        </div>

        <div id="contentWrap">
            <h3 id="title">A.M.A.L.I.A. Chat</h3>
            <div id="chatWrap">
                <div id="chat"></div>
                <form id="send-message">
                    <input size="23" id="message"></input>
                    <input type="submit" value="Send"></input>
                </form>
            </div>
            <p><b>Who's In!</b></p>
            <div id="users"></div>
        </div>


        <script src="http://code.jquery.com/jquery-latest.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            //shorthand for $( document ).ready()
            jQuery(function($){
                var socket = io.connect();
                var $nickForm = $('#setNick');
                var $nickError = $('#nickError');
                var $nickBox = $('username');
                var $users = $('#users');
                var $messageForm = $('#send-message');
                var $messageBox = $('#message');
                var $chat = $('#chat');


                //emits the socket
                socket.emit('new user', $nickBox.val(), function(data){
                    if(data){
                        $('#contentWrap').show(); //we show the chat div
                        $('#nickWrap').hide(); //we hide the nickname input div
                    } else {
                        $nickError.html('Error please try to login again!');
                    }
                });


                //adding list of users
                socket.on('usernames', function(data){
                   var html = '';
                    //going trough the array
                    for(var i=0; i < data.length; i++){
                        html += data[i] + "<br/>"
                    }
                    $users.html(html);
                });

                //functionality that send the message to the server
                $messageForm.submit(function(e){
                    e.preventDefault();
                    socket.emit('send message', $messageBox.val(), function(data){
                        $chat.append('<span error="msg">' + data + "<br/>");
                        document.body.scrollTop(455);
                        //document.getElementById("chat").scrollTop(455);
                        //document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
                    });
                    $messageBox.val(''); //to clean the message box
                });

                //here we are going to show the messages already present
                socket.on('load old msgs', function(docs){
                    //docs are like an array of every message received and we must go through it
                    for(var i=docs.length-1; i >= 0; i--){
                        displayMsg(docs[i]);
                    }
                });

                socket.on('new message', function(data){
                   //time to display the message
                    displayMsg(data);

                });

                //function to display the messages (used in old messages and the new ones)
                function displayMsg(data){
                    if((data.nick + ': ' + data.msg).length < 26){
                        $chat.append('<span class="msg"><b>' + data.nick + ': </b>' + data.msg + "<br/>");
                    } else {
                        var message = '<b>' + data.nick + ': </b>' + data.msg + '<br/>';

                        while (message.length >= 26){
                            //first we slice the message in a 26 letter phrase
                            var spcCheck = message.slice(0,26);
                            //then we find the last "space" on it
                            var spcPlace = spcCheck.lastIndexOf(" ");
                            //then we cut it in that place
                            var smalMsg = spcCheck.slice(0,spcPlace);
                            //we place it in the chat
                            $chat.append(smalMsg);
                            //the message now starts were it was cuted
                            message = message.substr(spcPlace,message.length);
                        }
                        //for last we place the remaing of the message
                        if(message.length < 26){
                            $chat.append(message);
                        }

                    }

                }

                //time to display the private message
                socket.on('whisper', function(data){
                    $chat.append('<span class="whisper"><b>' + data.nick + ': </b>' + data.msg + "<br/>");
                });
            });
        </script>
    </body>
</html>


